(function(e){function t(t){for(var o,c,i=t[0],a=t[1],d=t[2],l=0,h=[];l<i.length;l++)c=i[l],Object.prototype.hasOwnProperty.call(s,c)&&s[c]&&h.push(s[c][0]),s[c]=0;for(o in a)Object.prototype.hasOwnProperty.call(a,o)&&(e[o]=a[o]);u&&u(t);while(h.length)h.shift()();return r.push.apply(r,d||[]),n()}function n(){for(var e,t=0;t<r.length;t++){for(var n=r[t],o=!0,i=1;i<n.length;i++){var a=n[i];0!==s[a]&&(o=!1)}o&&(r.splice(t--,1),e=c(c.s=n[0]))}return e}var o={},s={app:0},r=[];function c(t){if(o[t])return o[t].exports;var n=o[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,c),n.l=!0,n.exports}c.m=e,c.c=o,c.d=function(e,t,n){c.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},c.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},c.t=function(e,t){if(1&t&&(e=c(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(c.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)c.d(n,o,function(t){return e[t]}.bind(null,o));return n},c.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return c.d(t,"a",t),t},c.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},c.p="/";var i=window["webpackJsonp"]=window["webpackJsonp"]||[],a=i.push.bind(i);i.push=t,i=i.slice();for(var d=0;d<i.length;d++)t(i[d]);var u=a;r.push([0,"chunk-vendors"]),n()})({0:function(e,t,n){e.exports=n("56d7")},"56d7":function(e,t,n){"use strict";n.r(t);n("e260"),n("e6cf"),n("cca6"),n("a79d");var o=n("2b0e"),s=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{attrs:{id:"app"}},[n("router-view")],1)},r=[],c=(n("5c0b"),n("2877")),i={},a=Object(c["a"])(i,s,r,!1,null,null,null),d=a.exports,u=n("8c4f"),l=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("h1",{staticStyle:{"text-align":"center"}},[e._v("视频聊天室")]),n("h3",[e._v("输入同样的房间名称即可发起聊天")]),n("div",{staticClass:"row1"},[n("input",{directives:[{name:"model",rawName:"v-model",value:e.roomid,expression:"roomid"}],attrs:{readonly:e.roomReadonly,type:"text",placeholder:"输入房间名称",id:"roomid"},domProps:{value:e.roomid},on:{input:function(t){t.target.composing||(e.roomid=t.target.value)}}}),n("button",{staticClass:"btn",attrs:{id:"connect"},on:{click:e.joinRoom}},[e._v("加入")]),n("button",{staticClass:"btn",attrs:{id:"disconnect"},on:{click:e.closeWS}},[e._v("离开/挂断")])]),n("div",{staticClass:"row2"},[n("button",{staticClass:"btn launchBtn",attrs:{id:"getAudio"},on:{click:function(t){return e.launchChat("audio")}}},[e._v("发起语音聊天")]),n("button",{staticClass:"btn launchBtn",attrs:{id:"getVideo"},on:{click:function(t){return e.launchChat("video")}}},[e._v("发起视频聊天")]),n("button",{staticClass:"btn launchBtn",attrs:{id:"getScreen"},on:{click:function(t){return e.launchChat("screenshare")}}},[e._v("发起屏幕共享")])]),n("textarea",{directives:[{name:"model",rawName:"v-model",value:e.logVal,expression:"logVal"}],attrs:{readonly:"",id:"logs"},domProps:{value:e.logVal},on:{input:function(t){t.target.composing||(e.logVal=t.target.value)}}}),n("div",{staticClass:"videobox"},[n("div",{staticClass:"localbox",staticStyle:{"margin-bottom":"20px"}},[n("div",{staticClass:"video-wrap"},[n("video",{ref:"localVideo",attrs:{muted:"",src:"",id:"localVideo"},domProps:{muted:!0}})])]),n("div",{staticClass:"remotebox"},[n("div",{staticClass:"video-wrap"},[n("video",{ref:"remoteVideo",attrs:{src:"",id:"remoteVideo"}})])])]),e._m(0),n("div",{staticClass:"screenshare"},[n("video",{ref:"remoteVideo",attrs:{src:"",id:"screenVideo",controls:""}})])])},h=[function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"audiobox"},[n("audio",{attrs:{src:"",controls:""}})])}],f=(n("99af"),n("4160"),n("159b"),n("53ca")),g=(n("96cf"),n("1da1")),p={data:function(){return{roomid:"",logVal:"",user:"",subType:"",isWsConnect:!1,isChat:!1,roomReadonly:!1,ws:"",serverConfig:{iceServers:[{urls:["stun:stun.xten.com"]}]},audio:"",localVideo:"",localVideoShow:!1,remoteVideo:"",remoteVideoShow:!1,localAudio:"",remoteAudioShow:!1,screenVideo:"",localStream:"",remoteStream:"",rtcPC:"",btnEls:{}}},watch:{isWsConnect:function(e,t){e?(this.roomReadonly=!0,this.btnEls.connect.disabled=!0,this.btnEls.disconnect.disabled=!1):this.roomReadonly=!1},isChat:function(e){e&&(this.btnEls.connect.getAudio=!0,this.btnEls.connect.getVideo=!0,this.btnEls.connect.getScreen=!0)}},mounted:function(){var e=this;this.initRtcPC(),this.localVideo=document.getElementById("localVideo"),this.remoteVideo=document.getElementById("remoteVideo"),this.screenVideo=document.getElementById("screenVideo"),this.audio=document.querySelector("audio"),this.remoteVideo.onloadeddata=function(){e.remoteVideo.play()},this.localVideo.onloadeddata=function(){e.localVideo.play()},this.screenVideo.onloadeddata=function(){e.screenVideo.play()},this.btnEls={getAudio:document.getElementById("getAudio"),getVideo:document.getElementById("getVideo"),getScreen:document.getElementById("getScreen"),connect:document.getElementById("connect"),disconnect:document.getElementById("disconnect")}},methods:{initRtcPC:function(){var e=this;console.log("init rtc"),this.closeRtcPC(),this.rtcPC=new RTCPeerConnection(this.serverConfig),this.rtcPC.addEventListener("icecandidate",(function(t){return e.onIceCandidate(t)})),this.rtcPC.addEventListener("iceconnectionstatechange",(function(t){return e.onIceStateChange(e.rtcPC,t)})),this.rtcPC.onaddstream=function(e){console.log("addStream")};var t=this;this.rtcPC.ontrack=function(e){console.log("ontrack"),t.remoteStream=e.streams,"audio"===t.subType?t.audio.srcObject!=e.streams[0]&&(t.audio.srcObject=e.streams[0],t.audio.pause(),t.audio.play()):"video"===t.subType?t.remoteVideo.srcObject!=e.streams[0]&&(t.remoteVideo.srcObject=e.streams[0]):"screenshare"===t.subType&&t.screenVideo.srcObject!=e.streams[0]&&(t.screenVideo.srcObject=e.streams[0])}},closeRtcPC:function(){var e=this;this.rtcPC&&(console.log("close rtc"),this.rtcPC.getLocalStreams().forEach((function(t){t.getTracks().forEach((function(e){return e.stop()})),console.log("getLocalStreams and stop",t),e.rtcPC.removeStream(t)})),this.rtcPC.getRemoteStreams().forEach((function(t){t.getTracks().forEach((function(e){return e.stop()})),console.log("getRemoteStreams stop",t),e.rtcPC.removeStream(t)})),this.rtcPC.close(),this.rtcPC="")},updateLog:function(e,t){this.logVal+=t||" "+e+"\n"},joinRoom:function(){""!=this.roomid?this.connectWs():alert("不能为空")},joinSuccess:function(e){this.user=e.user,this.isWsConnect=!0},connectWs:function(){var e=this;this.ws=new WebSocket("wss://127.0.0.1:8001"),this.ws.onopen=function(t){e.wsSendMessage("join","大家好")},this.ws.onclose=function(t){e.updateLog("离开房间,连接关闭"),e.isWsConnect=!1},this.ws.onerror=function(t){e.updateLog("连接出错",t),e.isWsConnect=!1},this.ws.onmessage=function(t){var n="";try{n=JSON.parse(t.data)}catch(o){n=t.data}e.handleWsMessage(n)}},wsSendMessage:function(e,t){var n=this;return Object(g["a"])(regeneratorRuntime.mark((function o(){return regeneratorRuntime.wrap((function(o){while(1)switch(o.prev=o.next){case 0:return t&&"object"==Object(f["a"])(t)&&(t=JSON.stringify(t)),"invite"==e&&console.log("sendmessage inite msg",t),o.next=4,n.ws.send(JSON.stringify({roomid:n.roomid,user:n.user,type:e,subType:n.subType,msg:t}));case 4:case"end":return o.stop()}}),o)})))()},handleWsMessage:function(e){switch(e.type){case"broadcast":this.updateLog(e.msg);break;case"invite":this.handleInvite(e);break;case"acceptInvite":this.acceptInvite(e);break;case"refuseInvite":this.refuseInvite(e);break;case"offer":this.recOffer(e);break;case"answer":this.getResponse(e.msg);break;case"candidate":this.addIceCandidate(e.msg);break;case"joinSuccess":this.joinSuccess(e);break;case"joinFail":this.isWsConnect=!1,this.updateLog(e.msg);break;default:this.updateLog(e.msg,"对方")}},judgeState:function(){return""!==this.roomid||(alert("请先加入房间"),!1)},launchChat:function(e){if(this.judgeState()){this.subType=e;var t="";"audio"===e?(this.updateLog("向对方发出语音聊天邀请"),t="对方邀请您语音聊天"):"video"===e?(this.updateLog("向对方发出视频聊天邀请"),t="对方邀请您视频聊天"):"screenshare"===e&&(this.updateLog("向对方发出观看屏幕共享邀请"),t="对方邀请您观看屏幕共享"),this.wsSendMessage("invite",t)}},handleInvite:function(e){this.updateLog(e.msg),console.log("handleInvie, msg",e.msg),this.subType=e.subType,window.confirm("是否接受"+e.msg)?(this.wsSendMessage("acceptInvite","接受邀请"),this.updateLog("接受对方邀请, 请允许打开相关设备")):(this.wsSendMessage("refuseInvite","拒绝邀请"),this.updateLog("拒绝对方邀请"))},handleVideoInvite:function(e){for(var t=document.getElementsByClassName("launchBtn"),n=0;n<t.length;n++)t[n].disables=!0;if(this.updateLog("对方发来视频聊天邀请"),window.confirm("是否接受视频聊天邀请"))this.initRtcPC(),this.wsSendMessage("acceptInvite","接受邀请"),this.updateLog("接受视频邀请, 请允许打开摄像头和麦克风");else{this.wsSendMessage("refuseInvite","拒绝邀请"),this.updateLog("拒绝视频邀请");for(var o=0;o<t.length;o++)t[o].disables=!0}},acceptInvite:function(e){this.updateLog("对方接受邀请"),this.initRtcPC(),this.openLocalDevice(e.subType,"createOffer")},refuseInvite:function(e){this.updateLog("对方拒绝邀请")},openLocalDevice:function(e,t,n){console.log("openLocalDevice",e),"audio"===e?(this.updateLog("请允许网页打开本地麦克风"),this.openAudioDevice(t,n)):"video"===e?(this.updateLog("请允许网页打开本地摄像头和麦克风"),this.openVideoDevice(t,n)):"screenshare"===e&&("createAnswer"===t?this.createAnswer(n):(this.updateLog("请选择共享窗口"),this.openDisplayDevice(t,n)))},openAudioDevice:function(e,t){var n=this;navigator.getUserMedia({audio:!0},(function(o){console.log("获取到本地音频流"),n.localStream=o,n.localStream.getTracks().forEach((function(e){return n.rtcPC.addTrack(e,n.localStream)})),console.log("openAudioDevice, add track to pc"),"createOffer"===e?n.createOffer():"createAnswer"===e&&n.createAnswer(t)}),(function(e){console.log("opendevice error",e),n.wsSendMessage("other",e)}))},openVideoDevice:function(e,t){var n=this;navigator.getUserMedia({video:!0,audio:!0},(function(o){console.log("获取到本地视频流"),n.localStream=o,n.localVideo.srcObject=o,n.localStream.getTracks().forEach((function(e){return n.rtcPC.addTrack(e,n.localStream)})),console.log("openVideoDevice, add track to pc"),"createOffer"===e?n.createOffer():"createAnswer"===e&&n.createAnswer(t)}),(function(e){console.log("opendevice error",e),n.wsSendMessage("other",e)}))},openDisplayDevice:function(e,t){var n=this;return Object(g["a"])(regeneratorRuntime.mark((function o(){var s;return regeneratorRuntime.wrap((function(o){while(1)switch(o.prev=o.next){case 0:return o.prev=0,o.next=3,navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0});case 3:s=o.sent,console.log("获取到本地共享窗口流"),n.localStream=s,n.screenVideo.srcObject=s,n.localStream.getTracks().forEach((function(e){return n.rtcPC.addTrack(e,n.localStream)})),console.log("openDisplayDevices, add track to pc"),"createOffer"===e?n.createOffer():"createAnswer"===e&&n.createAnswer(t),o.next=16;break;case 12:o.prev=12,o.t0=o["catch"](0),console.log("opendevice error",o.t0),n.wsSendMessage("other",o.t0);case 16:case"end":return o.stop()}}),o,null,[[0,12]])})))()},createOffer:function(){var e=this;this.rtcPC.createOffer((function(t){e.rtcPC.setLocalDescription(new RTCSessionDescription(t),(function(){console.log("createoffer"),e.wsSendMessage("offer",t)}),(function(e){console.log("setLocalDescription error",e)}))}),(function(e){console.log("createOffer error",e)}))},createAnswer:function(e){var t=this;this.rtcPC.setRemoteDescription(new RTCSessionDescription(e),(function(){t.rtcPC.createAnswer((function(e){t.rtcPC.setLocalDescription(new RTCSessionDescription(e),(function(){t.wsSendMessage("answer",e)}),(function(e){return console.log("setLocalDescription",e)}))}),(function(e){return console.log("createAnswer",e)}))}),(function(e){return console.log("setRemoteDescription",e)}))},getResponse:function(e){console.log("recAnswer",Object(f["a"])(e)),e=JSON.parse(e),this.rtcPC.setRemoteDescription(new RTCSessionDescription(e),(function(){}),(function(e){}))},recOffer:function(e){var t=this;return Object(g["a"])(regeneratorRuntime.mark((function n(){var o;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:console.log("recoffer",Object(f["a"])(e.msg)),o="object"===Object(f["a"])(e.msg)?e.msg:JSON.parse(e.msg),t.openLocalDevice(e.subType,"createAnswer",o);case 3:case"end":return n.stop()}}),n)})))()},onIceCandidate:function(e){var t=this;return Object(g["a"])(regeneratorRuntime.mark((function n(){return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:console.log("onIceCandidate");try{e.candidate&&t.wsSendMessage("candidate",e.candidate)}catch(o){console.log("onAddIceCandidateError",o)}case 2:case"end":return n.stop()}}),n)})))()},addIceCandidate:function(e){var t=this;return Object(g["a"])(regeneratorRuntime.mark((function n(){var o;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.prev=0,e=JSON.parse(e),o=new RTCIceCandidate(e),n.next=5,t.rtcPC.addIceCandidate(o);case 5:n.next=9;break;case 7:n.prev=7,n.t0=n["catch"](0);case 9:console.log("reciver candidate and add address",o.address),t.updateLog("对方address:"+o.address);case 11:case"end":return n.stop()}}),n,null,[[0,7]])})))()},onIceStateChange:function(e,t){e&&(console.log("".concat(e," ICE state: ").concat(e.iceConnectionState)),console.log("ICE state change event: ",t),"disconnected"===e.iceConnectionState&&this.closeRtcPC())},closeWS:function(){this.rtcPC&&this.closeRtcPC(),this.ws&&(this.wsSendMessage("leave","leave room"),this.wsSendMessage("leave","对方挂断了电话"),this.ws.close(),this.ws="",this.isWsConnect=!1)}},beforeDestroy:function(){this.closeWS()}},m=p,v=(n("7a24"),Object(c["a"])(m,l,h,!1,null,null,null)),b=v.exports;o["a"].use(u["a"]);var w=[{path:"/",name:"Chat",component:b},{path:"*",redirect:"/"}],C=new u["a"]({baseUrl:"videochat",routes:w}),S=C;o["a"].config.productionTip=!1,new o["a"]({router:S,render:function(e){return e(d)}}).$mount("#app")},"5c0b":function(e,t,n){"use strict";var o=n("9c0c"),s=n.n(o);s.a},"7a24":function(e,t,n){"use strict";var o=n("c250"),s=n.n(o);s.a},"9c0c":function(e,t,n){},c250:function(e,t,n){}});
//# sourceMappingURL=app.099cf05b.js.map